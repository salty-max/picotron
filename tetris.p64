picotron cartridge // www.picotron.net
version 2

:: gfx/
:: map/
:: sfx/
:: main.lua
--[[pod_format="raw",created="2026-01-02 00:23:59",modified="2026-01-02 21:42:03",revision=184]]
-- TODO
-- - clear lines
-- - game over
-- - hold down to drop faster
-- - press up to instant drop
-- - gui
-- - - show next piece
-- - - score
-- - - high score
-- - levels
-- - sound/music
-- - JUICE

-- Nice to have
-- - grab bag randomizer
-- - push on rotation
-- - piece preview

function _init()
	fix=10  -- playfield start x
	fiy=0   -- playfield start y
	fiw=10  -- playfield width
	fih=17  -- playfield height
	
	start_game()
end
function _update()
	_upd()
end
function _draw()
	_drw()
end
function update_game()
	-- movement
	if btnp(0)and test_piece(pix-1,piy,piid,prot)then
		pix-=1
	elseif btnp(1)and test_piece(pix+1,piy,piid,prot)then
		pix+=1
	end
	
	-- rotation
	if btnp(4)and test_piece(pix,piy,piid,prot+1)then
		prot+=1
	elseif btnp(5)and test_piece(pix,piy,piid,prot-1)then
		prot-=1
	end
	
	-- soft drop
	if btnp(3)then
		wait=0
	end
	
	-- update piece map
	pmap=put_piece(pix,piy,piid,prot)
	
	-- gravity
	wait-=1
	if wait<=0 then
		wait=max_wait
		piy+=1
		if test_piece(pix,piy,piid,prot)then
			pmap=put_piece(pix,piy,piid,prot)
		else
			piy-=1
			lock_piece()
		end
	end
end
function draw_game()
	cls()
	map()
	map(pmap,0,0,fix*16,fiy*16)
end
function start_game()
	_upd=update_game
	_drw=draw_game
	max_wait=30
	
	drop_piece()
end
function drop_piece()
	pix=4           	-- piece x pos
	piy=-1           	-- piece y pos
	piid=flr(rnd(7))	-- piece id
	prot=0          	-- piece rotation
	pmap=put_piece(pix,piy,piid,prot)
	
	wait=max_wait
end
function lock_piece()
	for px=0,fiw-1 do
		for py=0,fih-1 do
			if mget(fix+px,fiy+py)==0 then
				mset(fix+px,fiy+py,pmap:get(px,py))
			end
		end
	end
	
	drop_piece()
end
function iterate_piece(px,py,pi,pr,cb)
	pr=pr%4
	-- 4px width for long piece, 3 for others
	local cpw=pi==6 and 4 or 3
	local sx=31+pr*cpw
	local sy=pi*3

	
	for cpx=0,cpw-1 do
		for cpy=0,cpw-1 do
			local tile=mget(sx+cpx,sy+cpy)
			if cb(cpx,cpy,tile,px+cpx,py+cpy)==false then
				return false
			end
		end
	end
	
	return true
end

function put_piece(px,py,pi,pr)
	local tmp=userdata("i16",fiw,fih)
	
	iterate_piece(px,py,pi,pr,function(cpx,cpy,tile,wx,wy)
		tmp:set(wx,wy,tile)
	end)
	
	return tmp
end
function test_piece(px,py,pi,pr)
	return iterate_piece(px,py,pi,pr,function(cpx,cpy,tile,wx,wy)
		if tile!=0 then
			if wx<0 or wy<0 or wx>fiw-1 or wy>fih-1 then
				return false
			end
			if mget(fix+wx,fiy+wy)!=0 then
				return false
			end
		end
	end)
end
:: .info.pod
--[[pod,created="2025-11-13 21:07:43",modified="2026-01-02 21:50:39",runtime=24,workspaces={{location="main.lua#7",workspace_index=1},{location="gfx/0.gfx",workspace_index=2},{location="map/0.map",workspace_index=3},{location="sfx/0.sfx",workspace_index=4}}]]
:: gfx/.info.pod
--[[pod,created="2025-11-13 21:07:43",modified="2026-01-02 21:50:39"]]
:: gfx/0.gfx
b64$LS1bW3BvZCxjcmVhdGVkPSIyMDI1LTAxLTE3IDEwOjM1OjQ4Iixtb2RpZmllZD0iMjAyNi0w
MS0wMiAyMTo1MDozOSIscmV2aXNpb249MTFdXWx6NACMAgAAETQAAPMhe1swXT17Ym1wPXB4dQBD
IBAQBPBWBxAHwBfQF8AHEAfwVixmbGFncz0wLHBhbl94CADKeT0wLHpvb209OH0sPgDPEbAh0AHw
sAHQIbAROwAczxKwItAC8LAC0CKwEjsAHM8WsCbQBvCwBtAmsBY7ABwv8PAxAOBfoQ0BHQAFADgP
fwAcXwAdAQ2hBQA4D38AHN-xrS2xDdENER2hDQEtwAAhz-GgLfEADbEdEQ2hLYQAJC-w8DEAfh-x
MQAej6D9APEA-RDwQAEdr-AA-RDxAP0A8aC4AiTPLaENER2xDfEALfGgfAIhALYBnx0RDdENsS3x
rYkBfg8xAB7wBwDMEBwnHxx8AAw3HlwPEAwADBcOjA0HABCcBgAWHgYAH8wEAAC-vB0MABytHBDM
8AJ4AB3wAMoQGkd6AApXWgkKAAonigYAKxeaBgAfygQAAJ_6GQoAGqkaEMpzAB-yCs8eEB4vFx8O
fgAOPxcfDl4CDgAOHxcPDo4JABGeBwARDgcAEB0GAB-OBAAAn74SDgAeoh4Qzn8AIPEDGxAeJxt_
AA43G14DDgAOFwuOBwAQngYAFhsGAB-OBAAAb74TDgAeo3cAIvEEyBAYJx8XeAAINx5YAggACBcO
iAcAEJgGABYeBgAfyAQAAJ_4EggAGKIYEMjuACDQEBAeLxwcfgAOPRxeAVMBIQyOBwAQngYAFhwG
AB-OBAAAb74RDgAeoe8AIvAGyRAZJx8PeQAJNx5ZDxkJAAkXDokNBwAQmQYAFh4GAB-JBAAAv7kd
CQAZrRkQyfACqgMeDzEA--------------------------------------------------------
-xRQbT04fX0=
:: map/.info.pod
--[[pod,created="2025-11-13 21:07:43",modified="2026-01-02 21:50:39"]]
:: map/0.map
b64$LS1bW3BvZCxjcmVhdGVkPSIyMDI1LTAxLTE3IDEwOjM1OjQ4Iixtb2RpZmllZD0iMjAyNi0w
MS0wMiAyMTozNjo1MyIscmV2aXNpb249MzBdXWx6NACcAQAAugMAAPcUe3tibXA9cHh1AEyAMhsA
ABAAAAsABREAAAwAAAkACQAAAAoSANAQAAADAAAdAAIAAAEdCwBRAB0ABwAYADIJAAUtAAU2AAUS
AAE2AEECHQAAMAAmAAAMAA88ABQjAwB1AB8CMwAUcQIAAQAAAB5mABAePwAvAR45ABUUAjYAJgAA
DAAPPAAGcxMABRIAABQ8ABEDMwAfAjMAChEI0gBQAAAAARsGACEAGw4APxsACDAACkQBGwABMwAv
AxtdAAxBBAAAAjAAHwAqAAsAqQAxAAAaKgAxGgAEBgAPMAALIAIaMgAVBicABf8ACicAFwNXABQB
VwAtCBDVABEcgwARHDAAHxwkAAMAKQEQHAYAIwMcDAAPJwACAkIAfgEAAAIcAAghAD8CABIVAAEh
ARlUAAoGAC8lABsAChEDGgETGAYAESISAE0DGAABFQACDAAACwABBgBHABgAKSQA8Qv_AAAsaGlk
ZGVuPWZhbHNlLHBhbl94PTE2MwoA4nk9LTIsdGlsZV9oPTE2CgAQdwoAoHpvb209MC41fX0=
:: sfx/.info.pod
--[[pod,created="2025-11-13 21:07:43",modified="2026-01-02 21:50:39"]]
:: sfx/0.sfx
b64$LS1bW3BvZCxjcmVhdGVkPSIyMDI1LTA3LTMxIDA4OjMwOjI4Iixtb2RpZmllZD0iMjAyNS0w
Ny0zMSAwODozMDoyOCIscmV2aXNpb249MF1dbHo0AKAAAAALCgAA-zBweHUAAygAAAQABA9AEAIO
AAGgASACoA4ADxAADfDKAQIDQA8PkAQFBgdADJAICQoLQAyQDwwPDQ8ODEAM8P8BAOv-J6oBEAYP
MBABIAEgAfAAAhACDhABIA8hIAEwD0Dwww8oD--wxg-4Cg--D4AP9w8NAfAJARAGDjAA------_9
H-8BAKzPyA9AAA8QQP--sPD-AQD-6lD-----KQ==
:: [eoc]
